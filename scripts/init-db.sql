-- =============================================================================
-- PostgreSQL Initialization Script
-- PostgreSQL 初期化スクリプト
-- Enables required extensions for TimescaleDB + pgvector
-- TimescaleDBとpgvectorに必要な拡張機能を有効化
-- =============================================================================
--
-- 【このスクリプトの目的】
-- PostgreSQLデータベースが最初に作成されるとき、
-- 必要な拡張機能（Extension）を自動的にインストールします。
--
-- 【拡張機能（Extension）とは？】
-- PostgreSQLに追加機能を組み込む仕組み。
-- 標準のPostgreSQLにはない高度な機能を使えるようにする。
-- CREATE EXTENSION で有効化する。
--
-- 【IF NOT EXISTS】
-- すでにインストール済みの場合はスキップ（エラーにならない）。
-- べき等性（何回実行しても同じ結果）を保証する重要なパターン。
--
-- 【このスクリプトの実行タイミング】
-- Docker Composeでpostgresコンテナが初回起動する際に自動実行されます。
-- (docker-entrypoint-initdb.d/ に配置されるため)
-- =============================================================================

-- =============================================================================
-- TimescaleDB 拡張機能
-- =============================================================================
-- 【TimescaleDB（タイムスケールDB）とは？】
-- PostgreSQLの拡張機能で、時系列データの効率的な管理に特化しています。
--
-- 【時系列データとは？】
-- 時間順に記録されたデータのこと。ロボットの分野では非常に多い:
--   - センサーデータ (0.1秒ごとの温度、加速度...)
--   - LiDARスキャンデータ (10Hzで360度スキャン)
--   - バッテリー電圧の推移
--   - 位置情報（走行ログ）
--
-- 【なぜ通常のPostgreSQLでは不十分？】
-- 時系列データは:
--   1. 書き込みが非常に多い（1秒に何十回、何百回）
--   2. 古いデータが多く、新しいデータへのアクセスが多い
--   3. データ量が膨大になる
-- TimescaleDBはこれらの特性に最適化されている:
--   - ハイパーテーブル: 時間範囲で自動的にパーティション分割
--   - 圧縮: 古いデータを自動圧縮してストレージ節約
--   - 連続集約: リアルタイムで集計値（平均、最大等）を計算
-- =============================================================================

-- Enable TimescaleDB
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- =============================================================================
-- pgvector 拡張機能
-- =============================================================================
-- 【pgvector（ピージーベクター）とは？】
-- PostgreSQLでベクトル（数値の配列）を効率的に保存・検索する拡張機能。
--
-- 【ベクトルとは？（この文脈で）】
-- テキストや画像を「意味」を表す数値の列（埋め込みベクトル/Embedding）に変換したもの。
-- 例: "ロボットの速度が遅い" → [0.12, -0.34, 0.56, ..., 0.78]（768次元の数値列）
--
-- 【RAG（Retrieval-Augmented Generation）での使用】
-- RAGとは、LLM（大規模言語モデル）に外部知識を検索して回答させる手法:
--   1. ドキュメントをベクトルに変換してDBに保存
--   2. ユーザーの質問もベクトルに変換
--   3. 意味的に近いドキュメントをベクトル検索で取得
--   4. 取得したドキュメントをLLMに渡して回答生成
--
-- 【ベクトル検索（類似度検索）】
-- コサイン類似度、ユークリッド距離、内積などの指標で
-- 「意味が近い」ベクトルを高速に検索できる。
-- pgvectorはIVFFlat、HNSWなどの近似最近傍探索アルゴリズムに対応。
-- =============================================================================

-- Enable pgvector for RAG embeddings
CREATE EXTENSION IF NOT EXISTS vector;

-- =============================================================================
-- uuid-ossp 拡張機能
-- =============================================================================
-- 【UUID（Universally Unique Identifier）とは？】
-- 世界中で一意（ユニーク）なIDを生成する仕組み。
-- 形式: 550e8400-e29b-41d4-a716-446655440000（32桁の16進数 + ハイフン）
--
-- 【なぜ連番ID（1, 2, 3...）ではなくUUIDを使う？】
-- 1. セキュリティ: 連番だとIDを推測されてしまう（user/1, user/2...）
-- 2. 分散システム: 複数のサーバーで同時にIDを生成してもぶつからない
-- 3. マージ: 異なるDBのデータを統合する際にID衝突が起きない
--
-- 【uuid-osspとは？】
-- UUID生成関数を提供する拡張機能。
-- uuid_generate_v4() : ランダムなUUIDを生成（最も一般的）
-- "uuid-ossp"はハイフンを含むため、ダブルクォートで囲む必要がある。
-- =============================================================================

-- Enable uuid-ossp for UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =============================================================================
-- pg_trgm 拡張機能
-- =============================================================================
-- 【pg_trgm（トライグラム）とは？】
-- テキストの類似度検索・あいまい検索を高速にする拡張機能。
--
-- 【トライグラム（Trigram）とは？】
-- 文字列を3文字ずつに分割したもの。
-- 例: "robot" → {"  r", " ro", "rob", "obo", "bot", "ot "}
-- 2つの文字列のトライグラムの共通度合いで「似ている度」を計算。
--
-- 【どんな検索ができる？】
-- 1. あいまい検索: タイプミスがあっても検出
--    例: "robo" で "robot" を検索 → ヒットする
-- 2. LIKE/ILIKE検索の高速化: GINインデックスを使ってLIKE検索を高速化
--    例: WHERE name LIKE '%robot%' が高速に
-- 3. 類似度ランキング: similarity() 関数でスコア計算
--    例: similarity('robot', 'robit') → 0.6（似ている）
--
-- 【使用例（このアプリでは）】
-- - ロボット名の検索（部分一致、あいまい一致）
-- - エラーメッセージの類似検索
-- - ドキュメントの全文検索補助
-- =============================================================================

-- Enable pg_trgm for text search
CREATE EXTENSION IF NOT EXISTS pg_trgm;
