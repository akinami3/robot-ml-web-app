#!/usr/bin/env bash
# =============================================================================
# DB Migration Script
# データベースマイグレーションスクリプト
# =============================================================================
#
# 【マイグレーション（Migration）とは？】
# データベースの構造（テーブル、カラムなど）を段階的に変更・管理する仕組み。
# ソースコードをGitで管理するように、DBの構造変更もバージョン管理できます。
#
# 【なぜマイグレーションが必要？】
# 開発が進むと、データベースのテーブル構造も変わります:
#   - 新しいテーブルの追加（ユーザーテーブル → ロボットテーブル追加）
#   - カラムの追加（usersテーブルにavatar_urlカラム追加）
#   - カラムの型変更（VARCHAR(100) → VARCHAR(255)）
# このような変更を、チーム全員が同じように適用するために使います。
#
# 【Alembic（アレンビック）とは？】
# SQLAlchemy用のデータベースマイグレーションツール（Python製）。
# - マイグレーションファイル（Pythonスクリプト）を生成・管理
# - upgrade : 新しいバージョンに進む（テーブル作成、カラム追加など）
# - downgrade : 前のバージョンに戻る（変更を元に戻す）
# - revision : 新しいマイグレーションファイルを作成
#
# 【使い方】
#   ./scripts/migrate.sh upgrade head        # 全てのマイグレーションを適用
#   ./scripts/migrate.sh downgrade -1        # 最後のマイグレーションを元に戻す
#   ./scripts/migrate.sh create "add users"  # 新しいマイグレーション作成
#   ./scripts/migrate.sh current             # 現在のバージョンを確認
#   ./scripts/migrate.sh history             # マイグレーション履歴を表示
# =============================================================================

# シェルスクリプトの安全装置
set -euo pipefail

# スクリプトとプロジェクトのディレクトリを取得
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# -----------------------------------------------------------------------------
# コマンドライン引数の処理
# -----------------------------------------------------------------------------
# ACTION : 実行するアクション（upgrade, downgrade, create, current, history）
# ${1:-upgrade} : 第1引数が未指定ならデフォルトで "upgrade"
#
# ARGS : アクションに渡す追加引数
# ${2:-head} : 第2引数が未指定ならデフォルトで "head"
#
# 【"head"とは？】
# Alembicの用語で「最新のマイグレーション」を意味する。
# Git の HEAD（最新コミット）と同じ発想。
# upgrade head = 全ての未適用マイグレーションを最新まで適用
# -----------------------------------------------------------------------------
ACTION="${1:-upgrade}"
ARGS="${2:-head}"

# プロジェクトルートに移動
cd "$PROJECT_DIR"

# =============================================================================
# case文でアクションを分岐
# =============================================================================
# case "$ACTION" in ... esac : 値のパターンマッチングで処理を分岐
# （case文の詳しい説明はtest.shを参照）
# =============================================================================
case "$ACTION" in
    # -------------------------------------------------------------------------
    # upgrade : マイグレーションを適用（新しいバージョンに進む）
    # -------------------------------------------------------------------------
    # 【upgradeの動作】
    # 1. 現在のDBバージョンを確認
    # 2. 未適用のマイグレーションファイルを順番に実行
    # 3. alembic_versionテーブルにバージョン情報を記録
    #
    # 【"head"の意味】
    # head : 最新バージョンまで全て適用
    # 特定のリビジョン指定も可能（例: abc123def456）
    # -------------------------------------------------------------------------
    upgrade)
        echo "Running migrations (upgrade to $ARGS)..."
        # docker compose exec backend : backendコンテナ内でコマンド実行
        # alembic upgrade "$ARGS" : 指定バージョンまでマイグレーション適用
        docker compose exec backend alembic upgrade "$ARGS"
        ;;
    # -------------------------------------------------------------------------
    # downgrade : マイグレーションをロールバック（前のバージョンに戻す）
    # -------------------------------------------------------------------------
    # 【downgradeはいつ使う？】
    # - マイグレーションにバグがあった場合
    # - 新機能を取り消したい場合
    # - デプロイを元に戻したい場合
    #
    # 【引数の例】
    # -1 : 1つ前のバージョンに戻す
    # -2 : 2つ前のバージョンに戻す
    # base : 全てのマイグレーションを元に戻す（初期状態）
    # -------------------------------------------------------------------------
    downgrade)
        echo "Rolling back migrations (downgrade to $ARGS)..."
        docker compose exec backend alembic downgrade "$ARGS"
        ;;
    # -------------------------------------------------------------------------
    # create : 新しいマイグレーションファイルを自動生成
    # -------------------------------------------------------------------------
    # 【自動生成（autogenerate）の仕組み】
    # Alembicは以下を比較して差分を検出:
    #   1. SQLAlchemyのモデル定義（Pythonコード）= 期待するDB構造
    #   2. 実際のデータベースの構造
    # → 差分からupgrade/downgrade のPythonコードを自動生成
    #
    # 【-m オプション】
    # -m "migration description" : マイグレーションの説明文
    # ファイル名や履歴に表示されるので、分かりやすい名前をつける
    # 例: "add users table", "add avatar_url to users"
    # -------------------------------------------------------------------------
    create)
        # 引数チェック: 説明文が指定されていない場合はエラー
        # [ -z "$ARGS" ] : 文字列が空（長さゼロ）かチェック
        #   -z : zero length の意味
        if [ -z "$ARGS" ] || [ "$ARGS" = "head" ]; then
            echo "Usage: $0 create \"migration description\""
            exit 1
        fi
        echo "Creating migration: $ARGS"
        # alembic revision : 新しいマイグレーションファイルを作成
        # --autogenerate : モデルとDBの差分を自動検出
        # -m "$ARGS" : マイグレーションの説明メッセージ
        docker compose exec backend alembic revision --autogenerate -m "$ARGS"
        ;;
    # -------------------------------------------------------------------------
    # current : 現在適用されているマイグレーションのバージョンを表示
    # -------------------------------------------------------------------------
    # 【用途】
    # 今のDBがどのバージョンなのかを確認する。
    # デプロイ前後に確認するのが良い習慣。
    # -------------------------------------------------------------------------
    current)
        docker compose exec backend alembic current
        ;;
    # -------------------------------------------------------------------------
    # history : マイグレーションの全履歴を表示
    # -------------------------------------------------------------------------
    # --verbose : 詳細表示。各マイグレーションの説明や日時を表示
    # -------------------------------------------------------------------------
    history)
        docker compose exec backend alembic history --verbose
        ;;
    # -------------------------------------------------------------------------
    # デフォルト（不正な引数が指定された場合）
    # -------------------------------------------------------------------------
    *)
        echo "Usage: $0 [upgrade|downgrade|create|current|history] [args]"
        echo ""
        echo "Examples:"
        echo "  $0 upgrade head           # Apply all migrations"
        # ↑ 全ての未適用マイグレーションを適用
        echo "  $0 downgrade -1           # Rollback last migration"
        # ↑ 最後のマイグレーションを1つ元に戻す
        echo "  $0 create \"add users\"     # Create new migration"
        # ↑ 「add users」という説明の新しいマイグレーションファイルを作成
        echo "  $0 current                # Show current revision"
        # ↑ 現在のマイグレーションバージョンを表示
        echo "  $0 history                # Show migration history"
        # ↑ マイグレーションの全履歴を表示
        exit 1
        ;;
esac
