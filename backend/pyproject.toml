# =============================================================================
# pyproject.toml - Python プロジェクトの統合設定ファイル
# =============================================================================
#
# 【このファイルの役割】
# Python プロジェクトの「すべての設定」を 1 つのファイルにまとめたものです。
# 以前は setup.py, setup.cfg, requirements.txt, tox.ini など
# 複数のファイルに分散していた設定を、このファイルに統合できます。
#
# 【PEP 621 とは？】
# Python の公式仕様（PEP = Python Enhancement Proposal）の 1 つ。
# pyproject.toml でプロジェクトのメタデータ（名前、バージョン、依存関係など）を
# 記述する標準的な方法を定めています。
#
# 【TOML 形式とは？】
# Tom's Obvious, Minimal Language の略。
# 人間が読みやすい設定ファイル形式です。
# [セクション名] でグループ分けし、キー = "値" で設定を記述します。
# JSON や YAML に似ていますが、コメントが書けて読みやすいのが特徴。
#
# 【このファイルに含まれる設定】
# 1. [build-system]           → ビルドツールの設定
# 2. [project]                → プロジェクト情報と依存パッケージ
# 3. [project.optional-dependencies] → 開発用の追加パッケージ
# 4. [tool.ruff]              → コードリンター/フォーマッターの設定
# 5. [tool.mypy]              → 型チェッカーの設定
# 6. [tool.pytest]            → テストフレームワークの設定
# =============================================================================

# =============================================================================
# [build-system] - ビルドシステムの設定
# =============================================================================
# Python パッケージをビルド（配布可能な形式に変換）する際の設定。
#
# これは PEP 517/518 で定められた標準的な設定です。
# pip install . でインストールする際に、どのビルドツールを使うかを指定します。
#
# requires: ビルドに必要なパッケージ
#   setuptools: Python の標準的なビルドツール（>=68.0 = バージョン 68.0 以上）
#   wheel:      .whl 形式（高速インストール用パッケージ形式）のサポート
#
# build-backend: 実際にビルドを実行するモジュール
#   setuptools.build_meta が標準的な選択肢
# =============================================================================
[build-system]
requires = ["setuptools>=68.0", "wheel"]
build-backend = "setuptools.build_meta"

# ---------------------------------------------------------------------------
# [tool.setuptools.packages.find] - パッケージ自動検出の設定
# ---------------------------------------------------------------------------
# setuptools が Python パッケージを自動的に見つける設定。
# include = ["app*"] → "app" で始まるパッケージのみを含める
# これにより、tests/ や scripts/ などは除外される。
# ---------------------------------------------------------------------------
[tool.setuptools.packages.find]
include = ["app*"]

# =============================================================================
# [project] - プロジェクトメタデータ（PEP 621 準拠）
# =============================================================================
# pip install 時に使われるプロジェクトの基本情報と依存関係の定義。
# =============================================================================
[project]

# プロジェクト名（pip install robot-ai-backend でインストールされる名前）
name = "robot-ai-backend"

# バージョン番号（セマンティックバージョニング: メジャー.マイナー.パッチ）
# 0.1.0 = 開発初期段階（メジャーバージョン 0 = まだ安定版ではない）
version = "0.1.0"

# プロジェクトの説明文
description = "Robot AI Web Application - Backend API"

# 必要な Python バージョン（3.12 以上）
# Python 3.12 の新機能（型ヒントの改善、パフォーマンス向上など）を活用
requires-python = ">=3.12"

# =============================================================================
# dependencies - 本番環境で必要なパッケージ一覧
# =============================================================================
# pip install . で自動的にインストールされるパッケージです。
# 各パッケージの役割を以下に説明します。
# =============================================================================
dependencies = [
    # -------------------------------------------------------------------------
    # Web フレームワーク & サーバー
    # -------------------------------------------------------------------------

    # FastAPI: Python 製の高速 Web API フレームワーク
    # 自動 API ドキュメント生成、型バリデーション、非同期処理をサポート
    # Flask や Django REST framework の代替として人気が高い
    "fastapi>=0.115.0",

    # Uvicorn: ASGI サーバー（FastAPI を実際に動かすサーバー）
    # [standard] = WebSocket サポート等の追加機能を含む
    # 開発環境で使用（uvicorn app.main:app --reload で起動）
    "uvicorn[standard]>=0.30.0",

    # Gunicorn: 本番環境用の WSGI/ASGI サーバー
    # Uvicorn をワーカープロセスとして管理し、安定した運用を実現
    # 複数プロセスで並列処理することで高負荷に対応
    "gunicorn>=22.0.0",

    # -------------------------------------------------------------------------
    # データベース関連
    # -------------------------------------------------------------------------

    # SQLAlchemy: Python の ORM（Object-Relational Mapper）
    # SQL を直接書かずに、Python のクラスでデータベース操作ができる
    # [asyncio] = 非同期データベースアクセスをサポート
    # 例：user = await session.get(User, user_id)
    "sqlalchemy[asyncio]>=2.0.30",

    # asyncpg: PostgreSQL 用の非同期ドライバー
    # SQLAlchemy が PostgreSQL に接続する際に内部で使用される
    # 純粋な Python ではなく C 拡張で高速
    "asyncpg>=0.29.0",

    # Alembic: データベースマイグレーションツール（alembic.ini を参照）
    # テーブル構造の変更をバージョン管理する
    "alembic>=1.13.0",

    # -------------------------------------------------------------------------
    # データバリデーション & 設定管理
    # -------------------------------------------------------------------------

    # Pydantic: データバリデーション（検証）ライブラリ
    # API のリクエスト/レスポンスの型を定義し、自動的にバリデーションする
    # FastAPI と組み合わせて使う（FastAPI の中核技術）
    "pydantic>=2.7.0",

    # Pydantic Settings: 環境変数から設定を読み込むライブラリ
    # .env ファイルや環境変数から DATABASE_URL などの設定値を取得
    "pydantic-settings>=2.3.0",

    # -------------------------------------------------------------------------
    # 認証 & セキュリティ
    # -------------------------------------------------------------------------

    # python-jose: JWT（JSON Web Token）の生成と検証
    # ユーザーのログイン認証トークンを作成・検証する
    # [cryptography] = 暗号化ライブラリを使用（より安全）
    "python-jose[cryptography]>=3.3.0",

    # passlib: パスワードハッシュ化ライブラリ
    # ユーザーのパスワードを安全にハッシュ化して保存する
    # [bcrypt] = bcrypt アルゴリズムを使用（推奨される方式）
    "passlib[bcrypt]>=1.7.4",

    # bcrypt: パスワードハッシュアルゴリズムの実装
    # passlib が内部で使用する。バージョン 4.1 未満に制限（互換性のため）
    "bcrypt>=4.0.1,<4.1",

    # email-validator: メールアドレスの形式を検証するライブラリ
    # ユーザー登録時にメールアドレスが正しい形式かチェック
    "email-validator>=2.0.0",

    # python-multipart: マルチパートフォームデータの処理
    # ファイルアップロード（画像、PDF など）を処理するために必要
    "python-multipart>=0.0.9",

    # -------------------------------------------------------------------------
    # キャッシュ & セッション管理
    # -------------------------------------------------------------------------

    # Redis: インメモリデータストアのクライアント
    # セッション管理、キャッシュ、リアルタイム通知に使用
    # [hiredis] = C 製の高速パーサーを使用（パフォーマンス向上）
    "redis[hiredis]>=5.0.0",

    # -------------------------------------------------------------------------
    # HTTP クライアント
    # -------------------------------------------------------------------------

    # httpx: 非同期対応の HTTP クライアント
    # 外部 API（AI モデル API など）への HTTP リクエストに使用
    # requests ライブラリの非同期版として人気
    "httpx>=0.27.0",

    # -------------------------------------------------------------------------
    # ログ管理
    # -------------------------------------------------------------------------

    # structlog: 構造化ログライブラリ
    # JSON 形式でログを出力し、ログ集約ツール（ELK Stack 等）で分析しやすくする
    # 標準の logging より情報量が多く、デバッグしやすい
    "structlog>=24.1.0",

    # -------------------------------------------------------------------------
    # AI / ベクトル検索（RAG 関連）
    # -------------------------------------------------------------------------

    # pgvector: PostgreSQL のベクトル検索拡張
    # テキストを数値ベクトルに変換して類似検索を行う（RAG の検索部分）
    # 例：質問文のベクトルに近いドキュメントチャンクを検索
    "pgvector>=0.3.0",

    # -------------------------------------------------------------------------
    # gRPC（ロボット通信）
    # -------------------------------------------------------------------------

    # grpcio: gRPC の Python 実装
    # gateway_service.proto で定義したサービスを Python から呼び出すために使用
    "grpcio>=1.64.0",

    # grpcio-tools: .proto ファイルから Python コードを自動生成するツール
    # python -m grpc_tools.protoc で .proto → .py 変換
    "grpcio-tools>=1.64.0",

    # protobuf: Protocol Buffers の Python ライブラリ
    # gRPC のメッセージをシリアライズ（変換）するために使用
    "protobuf>=5.27.0",

    # -------------------------------------------------------------------------
    # ドキュメント処理（RAG のデータ取り込み用）
    # -------------------------------------------------------------------------

    # pypdf: PDF ファイルからテキストを抽出するライブラリ
    # ロボットのマニュアル PDF を読み込んで RAG のデータソースにする
    "pypdf>=4.2.0",

    # pandas: データ分析・処理ライブラリ
    # CSV や Excel ファイルの読み込み、データの前処理に使用
    "pandas>=2.2.0",

    # pyarrow: Apache Arrow の Python 実装
    # pandas の高速化バックエンドとして使用
    # 大規模データの効率的な読み書きをサポート
    "pyarrow>=16.0.0",
]

# =============================================================================
# [project.optional-dependencies] - 開発環境専用の追加パッケージ
# =============================================================================
# 本番環境では不要だが、開発時に必要なツールをまとめたもの。
# インストール方法: pip install -e ".[dev]"
#   -e = 編集可能モード（コード変更が即座に反映される）
#   ".[dev]" = dev グループの依存関係もインストール
# =============================================================================
[project.optional-dependencies]
dev = [
    # pytest: Python の標準的なテストフレームワーク
    # テストコードを書いて実行するためのツール
    # test_rag_service.py などのテストファイルを実行する
    "pytest>=8.2.0",

    # pytest-asyncio: pytest で非同期テストを実行するためのプラグイン
    # async def test_xxx() のような非同期テストを書ける
    "pytest-asyncio>=0.23.0",

    # pytest-cov: テストカバレッジ（網羅率）を測定するプラグイン
    # どのコードがテストされているか / されていないかを可視化
    # pytest --cov=app で実行
    "pytest-cov>=5.0.0",

    # testcontainers: テスト用に Docker コンテナを自動起動するライブラリ
    # テスト実行時に一時的な PostgreSQL や Redis を Docker で起動する
    # テスト終了後に自動的にコンテナを破棄する
    "testcontainers[postgres,redis]>=4.5.0",

    # httpx: テスト時に FastAPI のエンドポイントを呼び出すのに使用
    # 本番用の依存関係にもあるが、テスト時にも必要
    "httpx>=0.27.0",

    # ruff: 超高速な Python リンター & フォーマッター（Rust 製）
    # コードスタイルのチェックと自動修正を行う
    # flake8 + isort + black の代替として 1 つのツールで完結
    "ruff>=0.4.0",

    # mypy: Python の静的型チェッカー
    # 型ヒント（type hints）に基づいてコードの型エラーを検出
    # 実行前にバグを発見できる
    "mypy>=1.10.0",

    # pip-licenses: 依存パッケージのライセンス情報を一覧表示
    # オープンソースライセンスの確認・管理に使用
    "pip-licenses>=4.4.0",

    # factory-boy: テストデータ（フィクスチャ）を簡単に生成するライブラリ
    # テスト用のユーザーやロボットのデータを効率的に作成できる
    "factory-boy>=3.3.0",
]

# =============================================================================
# [tool.ruff] - Ruff リンター/フォーマッターの設定
# =============================================================================
# Ruff は Rust で書かれた超高速な Python コード品質ツールです。
# 従来の flake8（リンター）+ isort（import 整理）+ black（フォーマッター）を
# 1 つのツールに統合し、100 倍以上高速に動作します。
# =============================================================================
[tool.ruff]

# 対象の Python バージョン
# py312 = Python 3.12 の構文に対応（match 文、型ヒントの新構文など）
target-version = "py312"

# 1 行あたりの最大文字数（100 文字を超えると警告）
# PEP 8 では 79 文字が推奨だが、モダンな開発では 100〜120 が一般的
line-length = 100

# ---------------------------------------------------------------------------
# [tool.ruff.lint] - リントルールの設定
# ---------------------------------------------------------------------------
# select: 有効にするルールセットを指定
# 各アルファベットがルールカテゴリに対応：
#   E:   pycodestyle のエラー（コードスタイル違反）
#   F:   Pyflakes（未使用 import、未定義変数など）
#   I:   isort（import 文の並び順）
#   N:   pep8-naming（命名規則：クラス名は CamelCase、変数名は snake_case）
#   W:   pycodestyle の警告
#   UP:  pyupgrade（古い構文を新しい構文に置き換え提案）
#   B:   flake8-bugbear（よくあるバグパターンの検出）
#   SIM: flake8-simplify（コードの簡略化提案）
# ---------------------------------------------------------------------------
[tool.ruff.lint]
select = ["E", "F", "I", "N", "W", "UP", "B", "SIM"]

# =============================================================================
# [tool.mypy] - mypy 静的型チェッカーの設定
# =============================================================================
# mypy はコードを実行せずに型エラーを検出するツールです。
# TypeScript の型チェックに似た機能を Python で実現します。
#
# 例：
#   def add(a: int, b: int) -> int:
#       return a + b
#   add("hello", "world")  ← mypy がエラーを検出！（str を int に渡している）
# =============================================================================
[tool.mypy]

# 対象の Python バージョン
python_version = "3.12"

# strict = true: 最も厳格な型チェックモード
# すべての関数に型ヒントが必要で、Any 型の使用も警告される
# チーム開発での型安全性を最大限に確保
strict = true

# plugins: mypy のプラグイン
# pydantic.mypy: Pydantic モデルの型チェックを強化
# Pydantic の BaseModel を正しく型チェックできるようになる
plugins = ["pydantic.mypy"]

# =============================================================================
# [tool.pytest.ini_options] - pytest テストフレームワークの設定
# =============================================================================
# pytest の動作設定。以前は pytest.ini や setup.cfg に書いていたが、
# pyproject.toml に統合できるようになった。
# =============================================================================
[tool.pytest.ini_options]

# asyncio_mode = "auto": 非同期テストの自動検出モード
# async def test_xxx() を書くだけで自動的に非同期テストとして実行される
# "auto" を指定しない場合、@pytest.mark.asyncio デコレータが必要
asyncio_mode = "auto"

# testpaths: テストファイルを探すディレクトリ
# ["tests"] → backend/tests/ ディレクトリ内のテストファイルを対象
# pytest コマンドを実行すると、このディレクトリ内の test_*.py が自動実行される
testpaths = ["tests"]
