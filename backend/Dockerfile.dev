# =============================================================================
# バックエンド用 Dockerfile（開発環境向け）
# =============================================================================
#
# 【本番用（Dockerfile）との違い】
# - マルチステージビルドなし（シンプルな1段階構成）
# - 非rootユーザーなし（開発時はファイル権限の問題を避けるため）
# - --reload オプション付き（コード変更時に自動で再起動）
# - 開発用の追加依存関係（テストツール、リンターなど）もインストール
# - ヘルスチェックなし（開発時は不要）
#
# 【開発環境のDockerを使う理由】
# - Python のバージョンやライブラリのバージョンをチームで統一
# - データベースや Redis と一緒に docker-compose で一括起動
# - ローカル環境を汚さない（仮想環境のさらに上位の隔離）
# =============================================================================

# 【FROM python:3.12-slim】Python 3.12 の軽量版をベースイメージに使用
# 開発環境は1ステージで十分なので AS builder のようなステージ名は不要
FROM python:3.12-slim

# 作業ディレクトリを /app に設定
WORKDIR /app

# 【ビルドツールのアップグレード】
# pip: パッケージマネージャー
# setuptools: パッケージのビルドツール
# wheel: バイナリパッケージ形式のサポート
# --no-cache-dir: キャッシュを保存しない → イメージサイズ削減
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# 【プロジェクト設定ファイルのコピー】
# pyproject.toml に依存関係の一覧が定義されています
COPY pyproject.toml .

# アプリケーションコードのコピー
COPY app/ ./app/

# 【開発用インストール】
# -e: 「editable/編集可能モード」でインストール
#   通常のインストール: パッケージがsite-packagesにコピーされる
#   -e（editable）: シンボリックリンクが作られ、ソースコードの変更が即座に反映される
#   → コードを編集するたびに再インストールする必要がない
#
# ".[dev]": pyproject.toml の [project.optional-dependencies] セクションの
#   dev グループに定義された追加パッケージもインストール
#   例: pytest（テスト）, ruff（リンター）, mypy（型チェック）など
RUN pip install --no-cache-dir -e ".[dev]"

# 【必要なディレクトリの作成】
# /app/keys: JWT認証用の鍵ファイル格納ディレクトリ
# /tmp/exports: データエクスポート用の一時ディレクトリ
# ※ 開発環境では chown（所有者変更）は不要（rootで実行するため）
RUN mkdir -p /app/keys /tmp/exports

# 【EXPOSE 8000】FastAPIサーバーのポートを文書化
# 実際のポート公開は docker-compose.yml の ports 設定で行います
EXPOSE 8000

# 【CMD】コンテナ起動時のコマンド
# uvicorn: Pythonの非同期Webサーバー
#   app.main:app → app/main.py の app オブジェクトを起動
#   --host 0.0.0.0 → 全インターフェースでリッスン（Docker外からアクセス可能に）
#   --port 8000    → ポート8000で待ち受け
#   --reload       → 【開発専用オプション】
#     ファイルの変更を監視し、変更があるとサーバーを自動再起動
#     コードを修正するたびに手動でサーバーを再起動する必要がない
#     ※ 本番環境では使わない（パフォーマンスが低下するため）
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
