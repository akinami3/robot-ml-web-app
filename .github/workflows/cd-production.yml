# =============================================================================
# CD（継続的デリバリー）- 本番環境へのデプロイ
# =============================================================================
#
# 【本番デプロイの流れ】
# 1. developブランチで開発・テスト
# 2. ステージング環境で最終確認（cd-staging.yml）
# 3. mainブランチにマージ
# 4. バージョンタグ（v1.0.0など）を作成
# 5. このワークフローが自動実行 ← ここ
# 6. 本番環境にデプロイ
#
# 【なぜタグでトリガーするの？】
# - 明示的にバージョンを付けることで、いつリリースしたか明確になる
# - 問題があったら前のバージョンに簡単に戻せる（ロールバック）
# - セマンティックバージョニング（後述）でバージョン管理できる
#
# 【セマンティックバージョニング（SemVer）】
# バージョン番号の付け方のルールです。
# 形式: v{メジャー}.{マイナー}.{パッチ}  例: v1.2.3
#
# - メジャー（v1→v2）: 互換性のない大きな変更（APIの仕様変更など）
# - マイナー（v1.1→v1.2）: 後方互換性のある機能追加
# - パッチ（v1.2.0→v1.2.1）: バグ修正
#
# 【タグの作成方法】
# git tag v1.0.0           → タグを作成
# git push origin v1.0.0   → タグをGitHubにプッシュ → ワークフロー実行！

# ワークフロー名
name: Deploy Production

# =============================================================================
# トリガー設定
# =============================================================================
# 【tags: ["v*"] の意味】
# "v" で始まるタグがpushされたときに実行されます。
# 例: v1.0.0, v2.1.0-beta, v0.0.1 → 全て実行される
# 例: release-1.0 → "v" で始まらないため実行されない
on:
  push:
    tags: ["v*"]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # ---------------------------------------------------------------------------
  # ジョブ1: Dockerイメージのビルド＆プッシュ
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    # 3つのサービスを並列ビルド（マトリックス戦略）
    strategy:
      matrix:
        service: [gateway, backend, frontend]
    steps:
      - uses: actions/checkout@v4

      # 【バージョンタグの抽出】
      # GITHUB_REF にはフルパスが入っています: refs/tags/v1.0.0
      # ${GITHUB_REF#refs/tags/} で "refs/tags/" を除去して "v1.0.0" を取得
      #
      # >> $GITHUB_OUTPUT: ステップの出力として保存
      # → 後のステップで ${{ steps.version.outputs.tag }} として参照できる
      #
      # 【シェルのパラメータ展開】
      # ${変数#パターン}: 変数の先頭からパターンにマッチする部分を除去
      # 例: ${GITHUB_REF#refs/tags/} → "refs/tags/v1.0.0" → "v1.0.0"
      - name: Extract version
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          # 【本番用タグの付け方】
          # 2つのタグを付けます:
          # 1. :latest → 常に最新の本番バージョンを指す
          #    → docker pull で最新版を簡単に取得できる
          # 2. :v1.0.0 → そのバージョン固有のタグ（変更されない）
          #    → 特定バージョンを指定してデプロイ・ロールバックに使用
          #
          # 【:latest vs :バージョン の使い分け】
          # :latest → 開発時や最新版を常に使いたい場合
          # :バージョン → 本番環境で特定バージョンを固定したい場合（推奨）
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ steps.version.outputs.tag }}

  # ---------------------------------------------------------------------------
  # ジョブ2: 本番環境へのデプロイ
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    # 【environment: production】
    # 本番環境の設定です。
    # GitHubの Environment 設定で、以下のような保護ルールを追加できます:
    # - 必須レビュアー: 特定の人が承認しないとデプロイされない
    # - 待ち時間: デプロイ前に一定時間待機（キャンセル猶予）
    # - ブランチ制限: 特定のブランチ/タグからのみデプロイ可能
    #
    # 設定場所: リポジトリ → Settings → Environments → production
    environment: production
    steps:
      - uses: actions/checkout@v4
      # 【本番デプロイコマンド（プレースホルダー）】
      # 実際のデプロイは使用するインフラに合わせて実装します。
      #
      # 【一般的なデプロイ戦略】
      # 1. ローリングアップデート: 古いコンテナを1つずつ新しいものに置き換え
      # 2. Blue-Green デプロイ: 新環境を作ってから一気に切り替え
      # 3. カナリアデプロイ: 少数のユーザーに新バージョンを配信してテスト
      #
      # 【ロールバック（巻き戻し）】
      # 問題があったら前のバージョンのイメージを使って戻せます:
      # docker compose pull  # 前のバージョンのタグを指定
      # docker compose up -d
      - name: Deploy (placeholder)
        run: |
          echo "Deploy production with tag ${GITHUB_REF#refs/tags/}"
