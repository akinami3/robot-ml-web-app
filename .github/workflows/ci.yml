name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.22"
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  # --- Gateway (Go) ---
  gateway-lint:
    name: Gateway Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: gateway
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          working-directory: gateway
          version: latest

  gateway-test:
    name: Gateway Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: gateway
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - run: go test -v -race -coverprofile=coverage.out ./...
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: gateway-coverage
          path: gateway/coverage.out

  gateway-build:
    name: Gateway Build
    runs-on: ubuntu-latest
    needs: [gateway-lint, gateway-test]
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t robot-ai-gateway:ci ./gateway

  # --- Backend (Python) ---
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install ruff mypy
      - run: ruff check .
      - run: ruff format --check .

  backend-test:
    name: Backend Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install -e ".[dev]"
      - run: pytest -v --tb=short --cov=app --cov-report=xml
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.xml

  backend-build:
    name: Backend Build
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-test]
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t robot-ai-backend:ci ./backend

  # --- Frontend (React) ---
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npx eslint src/ --max-warnings 0
      - run: npx tsc --noEmit

  frontend-test:
    name: Frontend Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npx vitest run --coverage

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: [frontend-lint, frontend-test]
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t robot-ai-frontend:ci ./frontend

  # --- Integration ---
  docker-compose-check:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    needs: [gateway-build, backend-build, frontend-build]
    steps:
      - uses: actions/checkout@v4
      - name: Validate compose files
        run: |
          docker compose config -q
          docker compose -f docker-compose.yml -f docker-compose.dev.yml config -q
          docker compose -f docker-compose.yml -f docker-compose.prod.yml config -q
