// =============================================================================
// Vite 設定ファイル（vite.config.ts）
// =============================================================================
//
// 【Viteとは？】
// フロントエンド開発用の高速ビルドツール（バンドラー）です。
// 主な機能:
//   1. 開発サーバー: ファイル変更を検知し、ブラウザに即座に反映（HMR）
//   2. ビルド: TypeScript → JavaScript変換、ファイル結合、最適化
//   3. プロキシ: 開発時にAPIリクエストをバックエンドに転送
//
// 【バンドラーとは？】
// 多数のソースファイル（.ts, .tsx, .css等）を、ブラウザが効率的に
// 読み込める少数のファイルにまとめる（束ねる = bundle）ツールです。
// 例: 100個のTypeScriptファイル → 1つの最適化されたJavaScriptファイル
//
// 【HMR（Hot Module Replacement）とは？】
// コードを変更するとページ全体をリロードせずに、変更された部分だけを
// ブラウザ上で入れ替える仕組みです。
// - 状態（state）が保持されるため、開発効率が大幅に向上
// - 通常のリロードだと入力中のフォームデータなどが消えてしまうが、
//   HMRなら保持される
// =============================================================================

// 【import文】必要なモジュールを読み込みます
// defineConfig: Vite設定にTypeScriptの型補完を提供するヘルパー関数
import { defineConfig } from "vite";
// react: ViteでReactを使うためのプラグイン（JSX変換、HMR対応など）
import react from "@vitejs/plugin-react";
// path: Node.jsの標準ライブラリ。ファイルパスの操作に使用
import path from "path";

// 【defineConfig】Viteの設定オブジェクトをエクスポートします
// defineConfigで囲むことで、エディタの自動補完が効くようになります
export default defineConfig({
  // ===========================================================================
  // プラグイン設定
  // ===========================================================================
  // 【plugins】Viteの機能を拡張するプラグインの配列
  // react(): Reactの開発に必要な機能を追加
  //   - JSX/TSXファイルの変換（ブラウザが理解できるJSに変換）
  //   - React Fast Refresh（HMRでReactコンポーネントの状態を保持）
  //   - React DevToolsとの連携
  plugins: [react()],

  // ===========================================================================
  // パス解決（エイリアス）設定
  // ===========================================================================
  resolve: {
    // 【alias】インポートパスの短縮名（エイリアス）を定義
    alias: {
      // 【"@" エイリアス】
      // "@" を src/ ディレクトリのパスに変換します
      // 例: import Button from "@/components/Button"
      //   → import Button from "/home/user/project/src/components/Button"
      //
      // 【なぜエイリアスを使う？】
      //   相対パス: import Button from "../../../components/Button" ← 深いと長い！
      //   エイリアス: import Button from "@/components/Button"      ← 常に簡潔！
      //   ファイルを移動してもインポートパスの修正が不要
      //
      // 【__dirname】Node.jsの特殊変数。このファイルが存在するディレクトリのパス
      // 【path.resolve】複数のパスを結合して絶対パスを生成
      "@": path.resolve(__dirname, "./src"),
    },
  },

  // ===========================================================================
  // 開発サーバー設定
  // ===========================================================================
  server: {
    // 【port: 3000】開発サーバーがリッスンするポート番号
    // ブラウザで http://localhost:3000 にアクセスするとアプリが表示される
    port: 3000,

    // 【host: "0.0.0.0"】すべてのネットワークインターフェースでリッスン
    // "localhost" だとそのPC内からしかアクセスできないが、
    // "0.0.0.0" にすると同じネットワーク内の他のPC・Dockerコンテナからもアクセス可能
    host: "0.0.0.0",

    // 【proxy】開発時のAPIリクエスト転送設定
    // ブラウザは同一オリジンポリシーにより、異なるポートへのリクエストを制限する
    // プロキシを使うと、ブラウザ → Vite(3000) → バックエンド(8000) と中継できる
    // ブラウザからは同じオリジン（localhost:3000）へのリクエストに見える
    proxy: {
      // 【"/api" プロキシ】
      // /api で始まるリクエストをバックエンドサーバーに転送
      // 例: GET /api/users → http://localhost:8000/api/users
      "/api": {
        // 【target】転送先のサーバーURL
        // process.env.PROXY_BACKEND_URL: 環境変数で転送先を変更可能
        // || "http://localhost:8000": 環境変数がなければデフォルト値を使用
        target: process.env.PROXY_BACKEND_URL || "http://localhost:8000",
        // 【changeOrigin: true】
        // リクエストのHostヘッダーを転送先のホスト名に書き換える
        // 転送先サーバーが正しくリクエストを処理できるようにするため
        changeOrigin: true,
      },

      // 【"/ws" プロキシ】WebSocket通信の転送設定
      // ロボットのリアルタイムデータ通信に使用
      "/ws": {
        // WebSocket用のゲートウェイサーバーに転送
        target: process.env.PROXY_WS_URL || "ws://localhost:8080",
        // 【ws: true】WebSocketプロトコルの転送を有効化
        // 通常のHTTPプロキシとは異なる設定が必要なため、明示的に指定
        ws: true,
      },
    },
  },
});
